@{
    Layout = "~/Views/Shared/_ViewMain.cshtml";
    Page.Title = "Members";
    var userRole = Nistec.Types.ToInt( ViewBag.UserRole);
    string exportClass = userRole < 5 ? "hide" : "show";
}

@section head {


  @Scripts.Render("~/bundles/jqx")
  <script type="text/javascript" src="~/Scripts/app/main/members-query.js"></script>
    <style type="text/css">
        /*table {
            direction: rtl;
        }

        td {
            padding-top: 0px;
            padding-bottom: 5px;
        }*/
        .ui-accordion-header-active {
            background: #15C8D8;
        }
        #form-container {
            margin-left:auto;
            margin-right:0;
            max-width: 500px;
            direction: rtl;
        }
        .expander-item {
            padding: 0;
            margin: 0;
            /*direction: rtl;
            max-width: 400px;*/
        }
        .expander-entry {
            margin: 5px;
            /*direction:rtl;*/
        }
        .headline {
            color: #32A7C0;
            font-weight: bold;
        }
        input.edit {
            width:150px;
        }
    </style>
    @*<script>
        $(function () {
            $('#tab-query li:eq(0) a').tab('show');
        });
    </script>*@

    <script type="text/javascript">
        $(document).ready(function () {
            var me = this;

            //$('#jqxNotification').css('text-align', 'center').jqxNotification({
            //    width: '100%', position: "top-right", opacity: 0.9, rtl: true, browserBoundsOffset: 0,
            //    autoOpen: false, animationOpenDelay: 800//, autoClose: auto, autoCloseDelay: 3000, template: template
            //});

            $("#allBranch").prop('checked', true);
            $("#allCity").prop('checked', true);
            //$("#allPlace").prop('checked', true);
            $("#allCategory").prop('checked', true);
            //$("#allStatus").prop('checked', true);
            $("#allRegion").prop('checked', true);

            $("#accordion").accordion({ heightStyle: "content"});

        //$("#exp-1").jqxExpander({ width: 'auto', rtl: true, expanded: true });
        //$("#exp-2").jqxExpander({ width: 'auto', rtl: true, expanded: false });
        //$("#exp-3").jqxExpander({ width: 'auto', rtl: true, expanded: false });
        //$("#exp-4").jqxExpander({ width: 'auto', rtl: true, expanded: false });

            var branchAdapter = app_jqxcombos.createComboAdapter("PropId", "PropName", "listBranch", '@Url.Action("GetBranchView", "Common")', 240, 120, true);
        $('#listBranch').on('change', function (event) {
            app_jqxcombos.comboBoxToInput("listBranch", "Branch", "allBranch");
        });

        @*var chargeAdapter = createListAdapter("PropId", "PropName", "listCharge", '@Url.Action("GetChargeView", "Common")', 200, 120);*@

        @*var cityAdapter = createListAdapter("PropId", "PropName", "listCity", '@Url.Action("GetCityView", "Common")', 200, 120, true);
            $('#listCity').on('change', function (event) {
                listBoxToInput("listCity", "City");//, "allCity");
                //var items = $("#listCity").jqxListBox('getSelectedItems');
                //var checked = items && items.length > 0 ? true : false;
                //$("#allCity").prop('checked', !checked);
            });
             *@

        var enum1Agapter = app_jqx_list.enum1ComboAdapter();
        //$('#ExEnum1').on('change', function (event) {
        //    app_jqxcombos.comboBoxToInput("listStatus", "Status", "allStatus");
        //});
        app_jqx_list.enum2ComboAdapter();
        app_jqx_list.enum3ComboAdapter();
        app_members.displayMemberFields();

        @*var statusAdapter = app_jqxcombos.createComboAdapter("PropId", "PropName", "listStatus", '@Url.Action("GetStatusView", "Common")', 200, 120, false);
        $('#listStatus').on('change', function (event) {
            app_jqxcombos.comboBoxToInput("listStatus", "Status", "allStatus");
        });

        var placeAdapter = app_jqxcombos.createComboAdapter("PropId", "PropName", "listPlace", '@Url.Action("GetPlaceView", "Common")', 200, 120, true);
        $('#listPlace').on('change', function (event) {
            app_jqxcombos.comboBoxToInput("listPlace", "Place", "allPlace");
        });*@

            var sourceMerge = [
       { text: "מיזוג לקטגוריה", value: 0 },
       { text: "מיזוג לקטגוריה חדשה", value: 1 },
       { text: "הסרה מנויים מקטגוריה", value: 2 },
       { text: "הסרה ומחיקת מנויים", value: 3 },
            ];

            app_jqx.createDropDown("#MergeType", sourceMerge);//, width, tagTargetOnChange);
            $('#MergeType').on('change', function (event) {
                
                if (event.args.item.value == 1) {
                    $('#newCategory').show();
                    $('#syncCategory').hide();
                }
                else {
                    $('#newCategory').hide();
                    $('#syncCategory').show();
                }
            });

        var srcCategoryAdapter = app_jqx.createDataAdapter("PropId", "PropName", '@Url.Action("GetCategoriesView", "Common")', true);
        app_jqxcombos.createListBox(srcCategoryAdapter, "PropId", "PropName", "listCategory", 240, 200);
        app_jqxcombos.createComboBox(srcCategoryAdapter, "PropId", "PropName", "syncCategory", 240, 120);

        $('#syncCategory').jqxComboBox();
        $('#listCategory').jqxListBox({ multiple: true });
        $('#listCategory').on('change', function (event) {
            app_jqxcombos.listBoxToInput("listCategory", "Category", "allCategory");
        });
        $('#syncCategory').on('change', function (event) {
            app_jqxcombos.comboBoxToInput("syncCategory", "CategoryId");
        });


        var regionAdapter = app_jqxcombos.createListAdapter("PropId", "PropName", "listRegion", '@Url.Action("GetRegionView", "Common")', 240, 120, false);
        $('#listRegion').on('change', function (event) {
            app_jqxcombos.listBoxToInput("listRegion", "Region", "allRegion");
        });

        var currentRegion = function () {

            var reg = $("#Region").val();
            if (isNumeric(reg))
                return reg;
            return 0;
        }

        var citySource =
        {
            dataType: "json",
            dataFields: [
                { name: 'PropId' },
                { name: 'RegionId' },
                { name: 'PropName' }
            ],
            data: { 'region': currentRegion() },
            type: 'POST',
            url: '@Url.Action("GetCityRegionView", "Common")'
        };

        var cityAdapter = new $.jqx.dataAdapter(citySource, {
            //contentType: "application/json; charset=utf-8",
            loadError: function (jqXHR, status, error) {
                //alert("areaAdapter failed: " + error);
            },
            loadComplete: function (data) {
                //alert("areaAdapter is Loaded");
            }
        });
        // perform Data Binding.
        //areaAdapter.dataBind();


        $("#listCity").jqxListBox(
        {
            rtl: true,
            source: cityAdapter,
            width: 240,
            height: 120,
            multiple: true,
            displayMember: 'PropName',
            valueMember: 'PropId'
        });
        $('#listCity').on('change', function (event) {
            app_jqxcombos.listBoxToInput("listCity", "City");//, "allCity");
        });

        $("#listRegion").bind('select', function (event) {
            if (event.args) {

                $("#listCity").jqxListBox({ disabled: false, selectedIndex: -1 });
                var value = event.args.item.value;
                citySource.data = { 'region': value };
                cityAdapter = new $.jqx.dataAdapter(citySource);
                $("#listCity").jqxListBox({ source: cityAdapter });
                $("#City").val("");
            }
        });
        // perform Data Binding.
        //placeAdapter.dataBind();

        //$("#listBranch").jqxListBox('insertAt', "בחר הכל", 1);
        //$("#listCharge").jqxListBox('insertAt', { label: "בחר הכל", value: "-1" }, 1);
        //$("#listCity").jqxListBox('insertAt', { label: "בחר הכל", value: "-1" }, 1);
        //$("#listPlace").jqxListBox('insertAt', { label: "בחר הכל", value: "-1" }, 1);


        //$('#submit').on('click', function () {
        //    var action = $("#form").find('input[name=op]:checked').val();

        //    $("#form").attr('action', app.appPath() + action);
        //});
        $('#submitScreen').on('click', function () {

            var mergeType = $("#MergeType").val();
            if(mergeType==2 || mergeType==3)
            {
                if(confirm("פעולה זו תסיר מנויים מהמערכת , האם להמשיך?")==false)
                {
                    return;
                }
            }

            var actionurl = '/Common/CategoryMerge';
            //$("#form").attr('action', app.appPath() + action);
            //$("#form").submit();

            //var actionurl = '/Main/MembersExport';
            //$("#form").attr('action', app.appPath() + action);


            $.ajax({
                url: actionurl,
                type: 'post',
                dataType: 'json',
                data: $('#form').serialize(),
                success: function (data) {
                    if (data.Status > 0)
                        app_jqxnotify.Info(data, false, app.redirectTo, 'DefCategory');
                    else
                        app_jqxnotify.Error(data);

                    //if (data.Status > 0) 
                    //    app_dialog.alert(data.Message, app.redirectTo, 'DefCategory');
                    //else
                    //    app_dialog.alert(data.Message);

                },
                error: function (jqXHR, status, error) {
                    app_dialog.alert(error);
                }
            });

        });
        //$('#submitExport').on('click', function () {
        //    var action = '/Main/MembersExport';
        //    $("#form").attr('action', app.appPath() + action);
        //    $("#form").submit();
            //});

  
          $("input[name=op]:radio").change(function () {
            //$("#rdDefault, #rdSms", "#rdMail").change(function () {
            var action = $("#form").find('input[name=op]:checked').val();
            $("#form").attr('action', app.appPath() + action);
        });
        $('#reset').on('click', function () {
            location.reload();
        });

        $("#allCity").click(function () {

            var items = $("#listCity").jqxListBox('getItems');
            jQuery.each(items, function (i, item) {
                $("#listCity").jqxListBox('selectItem', item);
            });
            app_jqxcombos.listBoxToInput("listCity", "City");
        });
        $("#unselectAllCity").click(function () {
            $("#listCity").jqxListBox('clearSelection');
            $("#City").val("");
        });
            /*
        var activeExp;
        $('.expander').on('expanded', function () {
            if (activeExp === undefined) {
                activeExp = $('#exp-1');
            }
            if (this == activeExp)
                return;

                $(activeExp).jqxExpander({ expanded: false });
            //else if ($(this) != $('#exp-1'))
            //    $('#exp-1').jqxExpander({ expanded: false });
            //$("#form").find('.expander.jqx-expander-header-expanded').removeClass('jqx-expander-header-expanded');
            //$(this).jqxExpander({ expanded: true });
                activeExp = this;
        });
            */
    });

    </script>
}

<!--breadcrumb-->
<div class="breadcrumbs">
</div>
<div class="top-space"></div>

<div class="global-view">
    <div class="container-box">
        <div class="box-title">
            <h3>מיזוג מנויים לקטגוריה</h3>
        </div>
   
        <div id="form-container">
            <form id="form" action="CategoryMerge" method="post">

                <input type="hidden" id="CategoryId" name="CategoryId" />

                <input type="hidden" id="ExType" />

                <input type="hidden" id="Category" name="Category" />
                <input type="hidden" id="Status" name="Status" />
                <input type="hidden" id="Place" name="Place" />
                <input type="hidden" id="Branch" name="Branch" />
                <input type="hidden" id="Region" name="Region" />
                <input type="hidden" id="City" name="City" />
                <div id="accordion" class="tab-content1" dir="rtl">
                    <h3>איתור כללי</h3>
                    <div id="exp-1" style="padding:0;margin:0">
                        <div class="expander-entry">
                            <div>
                                <label class="headline">סיווג-בחירה מרובה</label>
                                <div id="listCategory" name="listCategory"></div>
                                <input type="checkbox" id="allCategory" name="allCategory" />&nbsp;<span>הצג הכל</span>
                            </div>
                            <div>
                                <div class="headline">סניף</div>
                                <div id="listBranch" name="Branch"></div>
                                <input type="checkbox" id="allBranch" name="allBranch" />&nbsp;<span>הצג הכל</span>
                            </div>
                            <div id="divEnum1">
                                <div id="lblEnum1" class="headline">סניף</div>
                                <div id="ExEnum1" name="ExEnum1"></div>
                                <input type="checkbox" id="allEnum1" name="allEnum1" />&nbsp;<span>הצג הכל</span>
                            </div>
                            <div id="divEnum2">
                                <div id="lblEnum2" class="headline">סטאטוס</div>
                                <div id="ExEnum2" name="ExEnum2"></div>
                                <input type="checkbox" id="allEnum2" name="allEnum12" />&nbsp;<span>הצג הכל</span>
                            </div>
                            <div id="divEnum3">
                                <div id="lblEnum3" class="headline">ארץ עלייה</div>
                                <div id="ExEnum3" name="ExEnum3"></div>
                                <input type="checkbox" id="allEnum3" name="allEnum3" />&nbsp;<span>הצג הכל</span>
                            </div>
                        </div>
                    </div>
                    <h3>איתור לפי כתובת</h3>
                    <div id="exp-2" style="padding:0;margin:0">
                        <div class="expander-entry">
                            <div>
                                <div class="headline">מחוז</div>
                                <div id="listRegion" name="listRegion"></div>
                                <input type="checkbox" id="allRegion" name="allRegion" />&nbsp;<span>הצג הכל</span>
                            </div>
                            <div>
                                <div class="headline">(שם היישוב (מתעדכן אוטומטית</div>
                                <div id="listCity" name="listCity"></div>
                                @*<input type="checkbox" id="allCity" name="allCity" />&nbsp;<span>הצג הכל</span>*@
                                <a href="#" id="allCity">סמן הכל</a>&nbsp;|&nbsp;
                                <a href="#" id="unselectAllCity">הסר</a>
                            </div>
                            <div>
                                <div class="headline">כתובת</div>
                                <input type="text" name="address" style="width:240px" maxlength="30" />
                            </div>
                        </div>
                    </div>
                    <h3>איתור לפי מזהה</h3>
                    <div id="exp-3" style="padding:0;margin:0">
                        <div class="expander-entry">

                            <div class="headline">תעודת זהות</div>
                            <div><input type="text" name="MemberId" class="edit" maxlength="10" /></div>
                            <div class="headline">טלפון נייד</div>
                            <div><input type="text" name="CellPhone" class="edit" maxlength=" 15" /></div>
                            <div class="headline">דואר אלקטרוני</div>
                            <div><input type="text" name="Email" class="edit" maxlength="100" /></div>

                            <div id="divExId">
                                <div id="lblExId" class="headline"></div>
                                <input type="text" name="ExId" style="width:120px" maxlength="50" />
                            </div>
                            <!--
                       <div id="divField1">
                           <div id="lblExField1" class="headline"></div>
                           <input type="text" name="ExField1" class="edit" maxlength="250" />
                       </div>
                       <div id="divField2">
                           <div id="lblExField2" class="headline"></div>
                           <input type="text" name="ExField2" class="edit" maxlength="250" />
                       </div>
                       <div id="divField3">
                           <div id="lblExField3" class="headline"></div>
                           <input type="text" name="ExField3" class="edit" maxlength="250" />
                       </div>
                    -->
                        </div>
                    </div>
                    <h3>איתור מתקדם</h3>
                    <div id="exp-4" style="padding:0;margin:0">
                        <div class="expander-entry">
                            <div>
                                <ul>
                                    <li>
                                        <div style="vertical-align:top">
                                            <div class="headline">גיל</div>
                                            <span>מ:</span>
                                            <input type="number" name="ageFrom" class="text-short" />
                                            <span>עד:</span>
                                            <input type="number" name="ageTo" class="text-short" />
                                        </div>
                                    </li>
                                    <li class="headline">הצטרפות לפני</li>
                                    <li><input type="number" name="monthlyTime" style="width:60px" /><span>חודשים</span></li>
                                    <li class="headline">שונות</li>
                                    <li><input type="checkbox" id="allBirthday" name="allBirthday" />&nbsp;<span>חוגגים החודש יום הולדת</span></li>
                                    <li><input type="checkbox" id="allCell" name="allCell" />&nbsp;<span>תקשורת לסלולאר</span></li>
                                    <li><input type="checkbox" id="allEmail" name="allEmail" />&nbsp;<span>תקשורת למייל</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="height:10px"></div>
                <div>
                    <div>
                        <label class="headline">סוג מיזוג</label>
                        <div id="MergeType" name="MergeType"></div>
                    </div>
                    <div class="headline">קטגוריה למיזוג</div>
                    <div>
                        @*<label class="headline">סיווג</label>*@
                        <input type="text" id="newCategory" name="newCategory" style="display:none" />
                        <div id="syncCategory" name="syncCategory"></div>
                    </div>
                </div>
                <div style="height:10px"></div>
                <div>
                    <input type="button" id="submitScreen" value="הצג" class="btn-default btn2" />
                    @*<input type="button" id="submitExport" value="ייצוא לקובץ" class="btn-default btn2" />*@
                    <input type="reset" value="נקה" class="btn-default btn2" />
                </div>
            </form>
        </div>
    </div>
</div>
 
<script type="text/javascript">
    app_menu.activeLayoutMenu("liEntity");
    app_menu.breadcrumbs("Main", "CategoryQuery", 'en');
    
</script>




