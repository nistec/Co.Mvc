@model ProSystem.Data.Entities.MediaSystem
@{

    ViewBag.Title = "Files";
    Layout = "~/Views/Shared/_ViewIframe.cshtml";
    var dataModel = @Html.Raw(Json.Encode(Model));
    //int buildingId = Model.BuildingId;
    //int propertyId = Model.UnitId;
    //string propertyType =Model.PropertyType;
}

@section head {

    @Scripts.Render("~/bundles/jqx")
    <script src="~/jqwidgets/jqxsplitter.js"></script>
    <script src="~/Scripts/plagins/colorbox/jquery.colorbox-min.js"></script>
    <link rel="stylesheet" href="~/Scripts/plagins/colorbox/colorbox.css" />

    <script src="~/Scripts/plagins/uploader/js/vendor/jquery.ui.widget.js"></script>
    <script src="~/Scripts/plagins/uploader/js/jquery.iframe-transport.js"></script>
    <script src="~/Scripts/plagins/uploader/js/jquery.fileupload.js"></script>
    
    <link rel="stylesheet" href="~/Scripts/plagins/uploader/css/jquery.fileupload.css">

}

@section scripts {

    <script type="text/javascript">
        var def;
    $(document).ready(function () {

        $('.group1').colorbox({ rel: 'group1' });

        def = new app_media_file('@dataModel');


        $('#FileId').val('@Model.FileId');
        $('#Pid').val('@Model.Pid');
        $('#Ptype').val('@Model.Ptype');
            //$("#fileremove").prop('disabled', true);
            $("#spnRemove").hide();


            $("#splitter").jqxSplitter({width: '100%', height: 300, panels: [{ size: '40%' }] });
           
            var mediaSource =
            {
                dataType: "json",
                dataFields: [
                    { name: 'FileName', type: 'string' },
                    { name: 'Pid', type: 'number' },
                    { name: 'MediaType', type: 'string' },
                    { name: 'FileSubject', type: 'string' },
                    { name: 'RefType', type: 'string' },
                    { name: 'RefId', type: 'string' },
                    { name: 'FilePath', type: 'string' }
                ],
                id: 'FileName',
                type: 'POST',
                data: { 'RefId': '@Model.RefId'},
            url: '@Url.Action("GetMediaRefFiles", "Media")'
        };
        var mediaAdapter = new $.jqx.dataAdapter(mediaSource);
        $("#MediaList").jqxListBox(
        {
            rtl: true,
            source: mediaAdapter,
            width: '100%',
            height: '100%',
            checkboxes: false,
            displayMember: 'FilePath',
            valueMember: 'FileName',
            selectedIndex: 0,
            itemHeight: 70,
            renderer: function (index, label, value) {
                //var datarecord = mediaAdapter[index];
                var table = '<table style="min-width: 130px;"><tr><td style="width: 40px;padding:8px;" rowspan="2">' + getImgTumb(label) + '</td><td>File Id : ' + value + '</td></tr><tr><td>Item Id :' + '@Model.RefId' + '</td></tr></table>';
                return table;
            }
        });

        $('#MediaList').on('select', function (event) {
            updatePanel(event.args.item);
            //$("#fileremove").prop('disabled', false);
            $("#spnRemove").show();
        });

        $("#fileremove").on('click', function (event) {
            //e.preventDefault();
            var mediaId = $('#uploadMid').val();
            if (confirm("האם למחוק? קובץ " + mediaId)) {
                doRemove();
            }
        });

        //var getMediaType = function (t) {
        //    switch (t) {
        //        case 'p':
        //            return 'photo';
        //        case 'v':
        //            return 'video';
        //    }
        //    return 'photo';
        //};
        var getPropertyType = function (t) {
            switch (t) {
                case 't':
                    return 'Task';
                case 'p':
                    return 'Project';
                case 'l':
                    return 'Leads';
            }
            return 'Task';
        };
        function getImgUrl(mediaType, picUrl) {
            if (mediaType == 'img')
                return '@Url.Content("~/" + @Model.AccountFolder + "/img")' + '/' + picUrl;
            else if (mediaType == 'video')
                return '@Url.Content("~/" + @Model.AccountFolder + "/video")' + '/' + picUrl;
            else if (mediaType == 'doc')
                return '@Url.Content("~/" + @Model.AccountFolder + "/doc")' + '/' + picUrl;
            else
                return picUrl;
        };

        function getImgTumb(picUrl) {
            var mediaType = getMediaType(picUrl);

            var imgurl;
            var imgtumb;
            if (mediaType == 'img') {
                imgurl = '@Url.Content("~/Uploads/img")' + '/' + picUrl;
                //imgtumb = $('<a class="group1" href="' + imgurl + '"><img src="' + imgurl + '" style="max-width:80px; height:auto;"/></a>').colorbox({ rel: 'group1' });
                //imgtumb = '<a class="group1" href="' + imgurl + '"><img src="' + imgurl + '" style="max-width:80px; height:auto;"/></a>';
                imgtumb = '<img src="' + imgurl + '" style="max-width:80px; height:auto;"/>'

            }
            else if (mediaType == 'video') {
                imgurl = '@Url.Content("~/Uploads/img")' + '/' + picUrl;
                imgtumb = '<img src="' + imgurl + '" style="max-width:80px; height:auto;"/>'
            }
            else if (mediaType == 'doc') {
                imgurl = '@Url.Content("~/Images/doc.jpg")';
                imgtumb = $('<span><img src="' + imgurl + '" style="max-width:80px; height:auto;"/></span>');
            }
            else if (mediaType == 'link') {
                imgurl = '@Url.Content("~/Images/link.jpg")';
                imgtumb = $('<span><img src="' + imgurl + '" style="max-width:80px; height:auto;"/></span>');
            }
            else {
                imgurl = '@Url.Content("~/Images/none.jpg")';
                imgtumb = $('<span><img src="' + imgurl + '" style="max-width:80px; height:auto;"/></span>');

            }
            return imgtumb;
        };
        function getImgTag(mediaType, picUrl) {

            var imgurl;
            var imgtag;

            if (mediaType == 'img') {
                imgurl = '@Url.Content("~/Uploads/img")' + '/' + picUrl;
                imgtag = $('<div style="margin: 10px;"><b>תמונה:</b><br/></div><div style="margin: 10px;overflow:auto;"><img src="' + imgurl + '"/></div>');
            }
            else if (mediaType == 'video') {
                imgurl = '@Url.Content("~/Uploads/img")' + '/' + picUrl;
                imgtag = $('<div style="margin: 10px;"><b>וידאו:</b><br/></div><div style="margin: 10px;overflow:auto;"><img src="' + imgurl + '"/></div>');
            }
            else if (mediaType == 'doc') {
                imgurl = '@Url.Content("~/Uploads/doc")' + '/' + picUrl;
                imgtag = $('<div style="margin: 10px;"><b>מסמך:</b><br/></div><div><a href="' + imgurl + '">לצפיה</a></div>');
            }
            else if (mediaType == 'link') {
                imgtag = $('<div style="margin: 10px;"><b>קישור:</b><br/></div><div><a href="' + picUrl + '">לצפיה</a></div>');
            }
            else {
                imgtag = $('<div style="margin: 10px;"><b>קישור:</b><br/></div><div><a href="' + picUrl + '">לצפיה</a></div>');

            }
            return imgtag;

            //return '<div style="margin: 10px;overflow:auto;"><img src="' + getImgUrl(mediaType,picUrl) + '"/></div>';
        };

        function getFileExtension(filename) {
            return filename.split('.').pop();
        };
        function getMediaType(filename) {
            if (filename.substr(0, 4) == 'http')
                return 'link';
            var extension = getFileExtension(filename);
            switch (extension.toLowerCase()) {
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                case 'tif':
                    return 'img';
                case 'mp4':
                case 'avi':
                    return 'video';
                case 'pdf':
                case 'doc':
                case 'docx':
                case 'xls':
                case 'xlsx':
                case 'csv':
                case 'txt':
                    return 'doc';

            }
            return "none";
        };

        var updatePanel = function (item) {

            //var datarecord = data[index];

            var mediaId = item.value;
            var picUrl = item.label;
            var mediaType = getMediaType(picUrl);


            $('#uploadMid').val(mediaId);
            $('#uploadMtype').val(mediaType);
            $('#uploadPath').val(picUrl);

            var container = $('<div style="margin: 5px;"></div>')

            //container.append("<input type='button' value='הסרת קובץ' onclick='doRemove()' />");
            //.on('click', function () {
            //     //e.preventDefault();
            //     if (confirm("האם למחוק?")) {
            //         doRemove();
            //     }
            // });

            container.append('<br/>');
            //var imgtag = getImgTag(mediaType, picUrl);
            var imgurl;
            var imgtag;
            if (mediaType == 'img') {
                imgurl = '@Url.Content("~/" + @Model.AccountFolder + "/img")' + '/' + picUrl;
                imgtag = $('<a class="group1" href="' + imgurl + '"><img src="' + imgurl + '" style="max-width:400px; height:auto;"/></a>').colorbox({ rel: 'group1' });
            }
            else if (mediaType == 'video') {
                imgurl = '@Url.Content("~/" + @Model.AccountFolder + "/video")' + '/' + picUrl;
                imgtag = $('<a class="group1" href="' + imgurl + '"><img src="' + imgurl + '" style="max-width:400px; height:auto;"/></a>').colorbox({ rel: 'group1' });
            }
            else if (mediaType == 'doc') {
                imgurl = '@Url.Content("~/" + @Model.AccountFolder + "/doc")' + '/' + picUrl;
                imgtag = $('<div style="margin: 10px;"><b>מסמך:</b><br/></div><div><a href="' + imgurl + '">לצפיה</a></div>');
            }
            else if (mediaType == 'link') {
                imgtag = $('<div style="margin: 10px;"><b>קישור:</b><br/></div><div><a href="' + picUrl + '">לצפיה</a></div>');
            }
            else {
                imgtag = $('<div style="margin: 10px;"><b>קישור:</b><br/></div><div><a href="' + picUrl + '">לצפיה</a></div>');
            }
            container.append(imgtag);


            //container.append(imgtag);

            //container.append("<div style='margin: 10px;'><b>תמונה:</b><br/></div>" + getImgTag(picUrl));

            $("#ContentPanel").html(container.html());

        };

        //updatePanel(0);

        //uploader

        var picuuid;
        var doUpload = function (data) {
            $.each(data.files, function (index, file) {
                var extension = getFileExtension(file.name);
                var uuid = app.generateUUID('16');
                var fname = '@Model.FilePrefix' +  $('#picid').val() + '.' + extension;
                $('<p/>').text(file.name).appendTo('#files');
                $('#files' + picnum).prepend($('<img>', { style: 'max-width:80px;height:auto', src: '@Url.Content("~/Uploads/media")' + '/' + fname }))//file.name }))
            });
        };
        var doPprogress = function (data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                'width',
                progress + '%'
            );
        };
        var resetPprogress = function () {
            $('#progress .progress-bar').css(
                'width', '0%'
            );
        };
        var getKeys = function (obj) {
            var keys = [];
            for (var key in obj) {
                keys.push(key);
            }
            return keys;
        }
        $('#fileupload').fileupload({
            url: '@Url.Action("MediaUpload", "Media")',//Url.Content("~/Ws/UploadFiles.asmx/MediaUpload")',
            formData: {
                param1: $('#uploadBid').val(),
                param2: $('#uploadUid').val(),
                param3: $('#uploadPt').val()
            },
            //dataType: 'json',
            done: function (e, data) {
                //var keys = Object.keys(data);
                alert(data.textStatus);
                resetPprogress();
                mediaAdapter.dataBind();
            },
            error: function (jqXHR, status, error) {
                alert(error);
            },
            progressall: function (e, data) {
                doPprogress(data);
            }
        }).prop('disabled', !$.support.fileInput)
             .parent().addClass($.support.fileInput ? undefined : 'disabled')
             .bind('fileuploadsubmit', function (e, data) {
                 resetPprogress();
                 //picuuid = generateUUID('16');
                 //data.formData = {
                 //    param1: $('#uploadBid').val(),
                 //    param2: $('#uploadUid').val(),
                 //    param3: $('#uploadPt').val()
                 //};
             });

        //$('#imgremove').click(function (e) {
        //    e.preventDefault();
        //    doRemove();
        //});
        var doRemove = function () {
            var id = $('#uploadMid').val();
            var filename = $('#uploadPath').val();
            var mediaType = $('#uploadMtype').val();

            $.ajax({
                url: '@Url.Action("MediaRemove","Media")',//Url.Content("~/Ws/UploadFiles.asmx/MediaRemove")',
                type: "POST",
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: "{'id':'" + id + "', 'mediaType' : '" + mediaType + "', 'filename':'" + filename + "'}",
                success: function (data) {
                    if (data) {
                        alert(data.Message);

                    }
                    //alert('הקובץ הוסר');
                    $('#files').html('');
                    mediaAdapter.dataBind();
                },
                error: function (jqXHR, status, error) {
                    alert(error);
                }
            });
        };

    });

    </script>
}

 <div style="margin:20px;">

        <div id="jqxWidget" style="margin: 0 auto; display: block; direction: rtl">
            <h3 class="rightPan">מדיה</h3>
            <div id="splitter">
                <div style="overflow: hidden;">
                    <div style="border: none;" id="MediaList">
                    </div>
                </div>
                <div style="overflow: auto;" id="ContentPanel">
                </div>
            </div>
            <div id="uploader">
                <div style="width: 250px">
                    <span>Select files...</span>
                    <input type="hidden" id="uploadBid" value="" />
                    <input type="hidden" id="uploadUid" value="" />
                    <input type="hidden" id="uploadPt" value="" />
                    <input type="hidden" id="uploadMid" value="" />
                    <input type="hidden" id="uploadMtype" value="" />
                    <input type="hidden" id="uploadPath" value="" />
                    <input type="hidden" id="uploadUuid" value="" />
                    <div style="padding: 10px">
                        <span class="btn btn-success fileinput-button">
                            <i class="glyphicon glyphicon-plus"><span>הוספת תמונה</span></i>
                            <input id="fileupload" type="file" name="files[]" multiple>
                        </span>
                        <span id="spnRemove" class="btn btn-success fileinput-button">
                            <i class="glyphicon glyphicon-minus"><span>הסרת תמונה</span></i>
                            <input id="fileremove" type="button" value="הסרת תמונה"/>
                        </span>
                        
                        <br>
                        <div id="progress" class="progress">
                            <div class="progress-bar progress-bar-success"></div>
                        </div>
                        <div id="files" class="files"></div>
                    </div>
                    <div>
                    </div>
                </div>
            </div>
        </div>
</div>
<!--end of content-wrapper-->
